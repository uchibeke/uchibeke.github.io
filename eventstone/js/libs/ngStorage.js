(function(root,factory){'use strict';if(typeof define==='function'&&define.amd){define(['angular'],factory);}else if(root.hasOwnProperty('angular')){factory(root.angular);}else if(typeof exports==='object'){module.exports=factory(require('angular'));}}(this,function(angular){'use strict';angular=(angular&&angular.module)?angular:window.angular;return angular.module('ngStorage',[]).provider('$localStorage',_storageProvider('localStorage')).provider('$sessionStorage',_storageProvider('sessionStorage'));function _storageProvider(storageType){return function(){var storageKeyPrefix='ngStorage-';this.setKeyPrefix=function(prefix){if(typeof prefix!=='string'){throw new TypeError('[ngStorage] - '+storageType+'Provider.setKeyPrefix() expects a String.');}storageKeyPrefix=prefix;};var serializer=angular.toJson;var deserializer=angular.fromJson;this.setSerializer=function(s){if(typeof s!=='function'){throw new TypeError('[ngStorage] - '+storageType+'Provider.setSerializer expects a function.');}serializer=s;};this.setDeserializer=function(d){if(typeof d!=='function'){throw new TypeError('[ngStorage] - '+storageType+'Provider.setDeserializer expects a function.');}deserializer=d;};this.get=function(key){return deserializer(window[storageType].getItem(storageKeyPrefix+key));};this.set=function(key,value){return window[storageType].setItem(storageKeyPrefix+key,serializer(value));};this.$get=['$rootScope','$window','$log','$timeout','$document',function($rootScope,$window,$log,$timeout,$document){function isStorageSupported(storageType){var supported;try{supported=$window[storageType];}catch(err){supported=false;}if(supported&&storageType==='localStorage'){var key='__'+Math.round(Math.random()*1e7);try{localStorage.setItem(key,key);localStorage.removeItem(key);}catch(err){supported=false;}}return supported;}var prefixLength=storageKeyPrefix.length;var webStorage=isStorageSupported(storageType)||($log.warn('This browser does not support Web Storage!'),{setItem:angular.noop,getItem:angular.noop,removeItem:angular.noop}),$storage={$default:function(items){for(var k in items){angular.isDefined($storage[k])||($storage[k]=angular.copy(items[k]));}$storage.$sync();return $storage;},$reset:function(items){for(var k in $storage){'$'===k[0]||(delete $storage[k]&&webStorage.removeItem(storageKeyPrefix+k));}return $storage.$default(items);},$sync:function(){for(var i=0,l=webStorage.length,k;i<l;i++){(k=webStorage.key(i))&&storageKeyPrefix===k.slice(0,prefixLength)&&($storage[k.slice(prefixLength)]=deserializer(webStorage.getItem(k)));}},$apply:function(){var temp$storage;_debounce=null;if(!angular.equals($storage,_last$storage)){temp$storage=angular.copy(_last$storage);angular.forEach($storage,function(v,k){if(angular.isDefined(v)&&'$'!==k[0]){webStorage.setItem(storageKeyPrefix+k,serializer(v));delete temp$storage[k];}});for(var k in temp$storage){webStorage.removeItem(storageKeyPrefix+k);}_last$storage=angular.copy($storage);}}},_last$storage,_debounce;$storage.$sync();_last$storage=angular.copy($storage);$rootScope.$watch(function(){_debounce||(_debounce=$timeout($storage.$apply,100,false));});$window.addEventListener&&$window.addEventListener('storage',function(event){if(!event.key){return;}var doc=$document[0];if((!doc.hasFocus||!doc.hasFocus())&&storageKeyPrefix===event.key.slice(0,prefixLength)){event.newValue?$storage[event.key.slice(prefixLength)]=deserializer(event.newValue):delete $storage[event.key.slice(prefixLength)];_last$storage=angular.copy($storage);$rootScope.$apply();}});$window.addEventListener&&$window.addEventListener('beforeunload',function(){$storage.$apply();});return $storage;}];};}}));